<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tipos de Lote - MRX Systems</title>
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#059669">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <header>
        <div class="header-content" style="justify-content: space-between;">
            <div class="logo">
                <img src="/static/images/mrx-logo.png" alt="MRX">
                <span>Tipos de Lote</span>
            </div>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div class="notification-badge" onclick="window.location.href='/notificacoes.html'">
                    <i class="fas fa-bell"></i>
                    <span class="notification-count" id="headerNotificationCount" style="display: none;">0</span>
                </div>
                <button class="btn btn-secondary" onclick="logout()" style="font-size: 0.875rem; padding: 0.5rem 1rem;">Sair</button>
            </div>
        </div>
    </header>

    <nav class="bottom-nav">
        <a href="/administracao.html" class="bottom-nav-item">
            <i class="fas fa-cog icon"></i>
            <span>Administra√ß√£o</span>
        </a>
        <a href="/dashboard.html" class="bottom-nav-item">
            <i class="fas fa-chart-line icon"></i>
            <span>Dashboard</span>
        </a>
        <div class="fab-container">
            <button class="fab-button" onclick="window.location.href='/funcionario.html'" aria-label="Nova Solicita√ß√£o">
                <i class="fas fa-plus icon"></i>
            </button>
        </div>
        <a href="/solicitacoes.html" class="bottom-nav-item">
            <i class="fas fa-file-alt icon"></i>
            <span>Solicita√ß√µes</span>
        </a>
        <a href="/fornecedores.html" class="bottom-nav-item">
            <i class="fas fa-building icon"></i>
            <span>Fornecedores</span>
        </a>
    </nav>

    <main class="container mt-4">
        <div class="flex justify-between items-center mb-3" style="flex-wrap: wrap; gap: var(--spacing-md);">
            <h1 style="font-size: clamp(1.5rem, 6vw, 2rem);">Gerenciar Tipos de Lote</h1>
            <button class="btn btn-primary" onclick="abrirModalNovoTipo()">+ Novo Tipo</button>
        </div>

        <div class="card">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>C√≥digo</th>
                            <th>Nome</th>
                            <th>Pre√ßos Configurados</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaTipos">
                        <tr><td colspan="4" class="loading">Carregando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Modal Tipo de Lote -->
    <div class="modal" id="modalTipo">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 id="tituloModalTipo">Novo Tipo de Lote</h2>
                <button class="modal-close" onclick="fecharModalTipo()">&times;</button>
            </div>
            <form id="formTipo">
                <input type="hidden" id="tipoId">
                
                <div class="form-group">
                    <label>Nome <span style="color: red;">*</span></label>
                    <input type="text" id="nome" required placeholder="Ex: Placa M√£e">
                </div>

                <div class="form-group">
                    <label>C√≥digo</label>
                    <input type="text" id="codigo" placeholder="Ex: PM001">
                </div>

                <div class="form-group">
                    <label>Descri√ß√£o</label>
                    <textarea id="descricao" rows="3" placeholder="Descri√ß√£o detalhada do tipo de lote"></textarea>
                </div>

                <!-- Grid de Pre√ßos 3x5 -->
                <div style="background: #f0fdf4; padding: 1.5rem; border-radius: 8px; margin-top: 1rem; border-left: 4px solid #10b981;">
                    <h4 style="margin: 0 0 1rem 0; color: #047857;">
                        üí∞ Tabela de Pre√ßos por Classifica√ß√£o e Estrelas (R$/kg)
                    </h4>
                    <p style="margin: 0 0 1rem 0; font-size: 0.9rem; color: #6b7280;">
                        Configure os 15 pre√ßos: 3 classifica√ß√µes √ó 5 estrelas cada
                    </p>
                    
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden;">
                            <thead>
                                <tr style="background: #059669; color: white;">
                                    <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Classifica√ß√£o</th>
                                    <th style="padding: 0.75rem; text-align: center;">‚≠ê 1</th>
                                    <th style="padding: 0.75rem; text-align: center;">‚≠ê‚≠ê 2</th>
                                    <th style="padding: 0.75rem; text-align: center;">‚≠ê‚≠ê‚≠ê 3</th>
                                    <th style="padding: 0.75rem; text-align: center;">‚≠ê‚≠ê‚≠ê‚≠ê 4</th>
                                    <th style="padding: 0.75rem; text-align: center;">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê 5</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                    <td style="padding: 0.75rem; font-weight: 600; color: #059669;">ü™∂ Leve</td>
                                    <td style="padding: 0.5rem;"><input type="number" id="preco_leve_1" step="0.01" min="0" placeholder="0.00" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;" required></td>
                                    <td style="padding: 0.5rem;"><input type="number" id="preco_leve_2" step="0.01" min="0" placeholder="0.00" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;" required></td>
                                    <td style="padding: 0.5rem;"><input type="number" id="preco_leve_3" step="0.01" min="0" placeholder="0.00" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;" required></td>
                                    <td style="padding: 0.5rem;"><input type="number" id="preco_leve_4" step="0.01" min="0" placeholder="0.00" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;" required></td>
                                    <td style="padding: 0.5rem;"><input type="number" id="preco_leve_5" step="0.01" min="0" placeholder="0.00" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;" required></td>
                                </tr>
                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                    <td style="padding: 0.75rem; font-weight: 600; color: #f59e0b;">‚öñÔ∏è M√©dio</td>
                                    <td style="padding: 0.5rem;"><input type="number" id="preco_medio_1" step="0.01" min="0" placeholder="0.00" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;" required></td>
                                    <td style="padding: 0.5rem;"><input type="number" id="preco_medio_2" step="0.01" min="0" placeholder="0.00" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;" required></td>
                                    <td style="padding: 0.5rem;"><input type="number" id="preco_medio_3" step="0.01" min="0" placeholder="0.00" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;" required></td>
                                    <td style="padding: 0.5rem;"><input type="number" id="preco_medio_4" step="0.01" min="0" placeholder="0.00" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;" required></td>
                                    <td style="padding: 0.5rem;"><input type="number" id="preco_medio_5" step="0.01" min="0" placeholder="0.00" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;" required></td>
                                </tr>
                                <tr>
                                    <td style="padding: 0.75rem; font-weight: 600; color: #ef4444;">‚öì Pesado</td>
                                    <td style="padding: 0.5rem;"><input type="number" id="preco_pesado_1" step="0.01" min="0" placeholder="0.00" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;" required></td>
                                    <td style="padding: 0.5rem;"><input type="number" id="preco_pesado_2" step="0.01" min="0" placeholder="0.00" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;" required></td>
                                    <td style="padding: 0.5rem;"><input type="number" id="preco_pesado_3" step="0.01" min="0" placeholder="0.00" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;" required></td>
                                    <td style="padding: 0.5rem;"><input type="number" id="preco_pesado_4" step="0.01" min="0" placeholder="0.00" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;" required></td>
                                    <td style="padding: 0.5rem;"><input type="number" id="preco_pesado_5" step="0.01" min="0" placeholder="0.00" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;" required></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div style="display: flex; gap: 0.5rem; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="fecharModalTipo()" style="flex: 1;">Cancelar</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/static/js/auth.js"></script>
    <script>
        let tiposLote = [];

        function mostrarMensagem(mensagem, tipo = 'success') {
            alert(mensagem);
        }

        async function carregarTipos() {
            try {
                const response = await fetch('/api/tipos-lote', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) throw new Error('Erro ao carregar tipos de lote');

                tiposLote = await response.json();
                renderizarTabela();
            } catch (error) {
                console.error('Erro:', error);
                mostrarMensagem('Erro ao carregar tipos de lote', 'error');
            }
        }

        function renderizarTabela() {
            const tbody = document.getElementById('tabelaTipos');
            
            if (tiposLote.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 2rem;">Nenhum tipo de lote cadastrado</td></tr>';
                return;
            }

            tbody.innerHTML = tiposLote.map(tipo => {
                const precos = tipo.precos || {};
                let precosInfo = '';
                
                if (Object.keys(precos).length > 0) {
                    precosInfo = '<div style="font-size: 0.85rem;">';
                    ['leve', 'medio', 'pesado'].forEach(classif => {
                        if (precos[classif]) {
                            const icone = classif === 'leve' ? 'ü™∂' : classif === 'medio' ? '‚öñÔ∏è' : '‚öì';
                            const estrelas = Object.keys(precos[classif]).length;
                            precosInfo += `<span style="margin-right: 1rem;">${icone} ${estrelas} pre√ßos</span>`;
                        }
                    });
                    precosInfo += '</div>';
                } else {
                    precosInfo = '<span style="color: #dc2626; font-size: 0.85rem;">Sem pre√ßos</span>';
                }
                
                return `
                <tr>
                    <td><strong>${tipo.codigo || '-'}</strong></td>
                    <td>${tipo.nome}</td>
                    <td>${precosInfo}</td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="editarTipo(${tipo.id})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deletarTipo(${tipo.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `}).join('');
        }

        function abrirModalNovoTipo() {
            document.getElementById('tituloModalTipo').textContent = 'Novo Tipo de Lote';
            document.getElementById('formTipo').reset();
            document.getElementById('tipoId').value = '';
            
            ['leve', 'medio', 'pesado'].forEach(classif => {
                for (let i = 1; i <= 5; i++) {
                    document.getElementById(`preco_${classif}_${i}`).value = '';
                }
            });
            
            document.getElementById('modalTipo').style.display = 'flex';
        }

        function fecharModalTipo() {
            document.getElementById('modalTipo').style.display = 'none';
        }

        async function editarTipo(id) {
            const tipo = tiposLote.find(t => t.id === id);
            if (!tipo) return;

            document.getElementById('tituloModalTipo').textContent = 'Editar Tipo de Lote';
            document.getElementById('tipoId').value = tipo.id;
            document.getElementById('nome').value = tipo.nome;
            document.getElementById('codigo').value = tipo.codigo || '';
            document.getElementById('descricao').value = tipo.descricao || '';
            
            ['leve', 'medio', 'pesado'].forEach(classif => {
                for (let i = 1; i <= 5; i++) {
                    const campo = document.getElementById(`preco_${classif}_${i}`);
                    if (tipo.precos && tipo.precos[classif] && tipo.precos[classif][i]) {
                        campo.value = tipo.precos[classif][i];
                    } else {
                        campo.value = '';
                    }
                }
            });
            
            document.getElementById('modalTipo').style.display = 'flex';
        }

        document.getElementById('formTipo').addEventListener('submit', async (e) => {
            e.preventDefault();

            const tipoId = document.getElementById('tipoId').value;
            
            const precos = {
                leve: {},
                medio: {},
                pesado: {}
            };
            
            ['leve', 'medio', 'pesado'].forEach(classif => {
                for (let i = 1; i <= 5; i++) {
                    const valor = document.getElementById(`preco_${classif}_${i}`).value;
                    if (valor) {
                        precos[classif][i] = parseFloat(valor);
                    }
                }
            });
            
            const dados = {
                nome: document.getElementById('nome').value,
                codigo: document.getElementById('codigo').value,
                descricao: document.getElementById('descricao').value,
                precos: precos
            };

            try {
                const url = tipoId ? `/api/tipos-lote/${tipoId}` : '/api/tipos-lote';
                const method = tipoId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(dados)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.erro || 'Erro ao salvar');
                }

                mostrarMensagem(tipoId ? 'Tipo de lote atualizado com sucesso!' : 'Tipo de lote criado com sucesso!');
                fecharModalTipo();
                await carregarTipos();
            } catch (error) {
                console.error('Erro:', error);
                mostrarMensagem(error.message, 'error');
            }
        });

        async function deletarTipo(id) {
            if (!confirm('Tem certeza que deseja deletar este tipo de lote?')) return;

            try {
                const response = await fetch(`/api/tipos-lote/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.erro || 'Erro ao deletar');
                }

                mostrarMensagem('Tipo de lote deletado com sucesso!');
                await carregarTipos();
            } catch (error) {
                console.error('Erro:', error);
                mostrarMensagem(error.message, 'error');
            }
        }

        window.addEventListener('click', (e) => {
            if (e.target === document.getElementById('modalTipo')) {
                fecharModalTipo();
            }
        });

        carregarTipos();
    </script>
</body>
</html>
