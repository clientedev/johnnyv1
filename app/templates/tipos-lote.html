<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tipos de Lote - MRX Systems</title>
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#059669">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <header>
        <div class="header-content" style="justify-content: space-between;">
            <div class="logo">
                <img src="/static/images/mrx-logo.png" alt="MRX">
                <span>Tipos de Lote</span>
            </div>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div class="notification-badge" onclick="window.location.href='/notificacoes.html'">
                    <i class="fas fa-bell"></i>
                    <span class="notification-count" id="headerNotificationCount" style="display: none;">0</span>
                </div>
                <button class="btn btn-secondary" onclick="logout()" style="font-size: 0.875rem; padding: 0.5rem 1rem;">Sair</button>
            </div>
        </div>
    </header>

    <nav class="bottom-nav">
        <a href="/administracao.html" class="bottom-nav-item">
            <i class="fas fa-cog icon"></i>
            <span>Administra√ß√£o</span>
        </a>
        <a href="/dashboard.html" class="bottom-nav-item">
            <i class="fas fa-chart-line icon"></i>
            <span>Dashboard</span>
        </a>
        <div class="fab-container">
            <button class="fab-button" onclick="window.location.href='/funcionario.html'" aria-label="Nova Solicita√ß√£o">
                <i class="fas fa-plus icon"></i>
            </button>
        </div>
        <a href="/solicitacoes.html" class="bottom-nav-item">
            <i class="fas fa-file-alt icon"></i>
            <span>Solicita√ß√µes</span>
        </a>
        <a href="/fornecedores.html" class="bottom-nav-item">
            <i class="fas fa-building icon"></i>
            <span>Fornecedores</span>
        </a>
    </nav>

    <main class="container mt-4">
        <div class="flex justify-between items-center mb-3" style="flex-wrap: wrap; gap: var(--spacing-md);">
            <h1 style="font-size: clamp(1.5rem, 6vw, 2rem);">Gerenciar Tipos de Lote</h1>
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <button class="btn btn-secondary" onclick="document.getElementById('fileExcel').click()">
                    <i class="fas fa-file-excel"></i> Importar Excel
                </button>
                <button class="btn btn-primary" onclick="abrirModalNovoTipo()">+ Novo Tipo</button>
            </div>
        </div>

        <input type="file" id="fileExcel" accept=".xlsx,.xls" style="display: none;" onchange="importarExcel()">

        <div class="card">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>C√≥digo</th>
                            <th>Nome</th>
                            <th>Classifica√ß√£o</th>
                            <th>Pre√ßos Configurados</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaTipos">
                        <tr><td colspan="5" class="loading">Carregando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Modal Tipo de Lote -->
    <div class="modal" id="modalTipo">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 id="tituloModalTipo">Novo Tipo de Lote</h2>
                <button class="modal-close" onclick="fecharModalTipo()">&times;</button>
            </div>
            <form id="formTipo">
                <input type="hidden" id="tipoId">
                
                <div class="form-group">
                    <label>Nome <span style="color: red;">*</span></label>
                    <input type="text" id="nome" required placeholder="Ex: Placa M√£e">
                </div>

                <div class="form-group">
                    <label>C√≥digo</label>
                    <input type="text" id="codigo" placeholder="Ex: PM001">
                </div>

                <div class="form-group">
                    <label>Classifica√ß√£o <span style="color: red;">*</span></label>
                    <select id="classificacao" required onchange="atualizarCamposPrecos()">
                        <option value="">Selecione...</option>
                        <option value="leve">Leve</option>
                        <option value="media">M√©dia</option>
                        <option value="pesada">Pesada</option>
                    </select>
                    <small style="color: #666;">A classifica√ß√£o define a categoria de peso do material</small>
                </div>

                <div id="camposPrecosPadrao" style="display: none; background: #f0fdf4; padding: 1.5rem; border-radius: 8px; margin-top: 1rem; border-left: 4px solid #10b981;">
                    <h4 style="margin: 0 0 1rem 0; color: #047857; display: flex; align-items: center; gap: 0.5rem;">
                        üí∞ Pre√ßos Padr√£o por Estrela
                    </h4>
                    <p style="margin: 0 0 1rem 0; font-size: 0.9rem; color: #6b7280;">
                        Defina os pre√ßos padr√£o para cada n√≠vel de qualidade. Quantas estrelas esse tipo aceita?
                    </p>
                    
                    <div style="display: grid; gap: 0.75rem;">
                        <div style="display: grid; grid-template-columns: 120px 1fr; align-items: center; gap: 1rem;">
                            <label style="margin: 0; font-weight: 500;">‚≠ê 1 Estrela</label>
                            <div style="display: flex; align-items: center;">
                                <span style="margin-right: 0.5rem;">R$</span>
                                <input type="number" id="precoPadrao1" step="0.01" min="0" placeholder="0.00" style="flex: 1; padding: 0.5rem;">
                                <span style="margin-left: 0.5rem;">/kg</span>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 120px 1fr; align-items: center; gap: 1rem;">
                            <label style="margin: 0; font-weight: 500;">‚≠ê‚≠ê 2 Estrelas</label>
                            <div style="display: flex; align-items: center;">
                                <span style="margin-right: 0.5rem;">R$</span>
                                <input type="number" id="precoPadrao2" step="0.01" min="0" placeholder="0.00" style="flex: 1; padding: 0.5rem;">
                                <span style="margin-left: 0.5rem;">/kg</span>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 120px 1fr; align-items: center; gap: 1rem;">
                            <label style="margin: 0; font-weight: 500;">‚≠ê‚≠ê‚≠ê 3 Estrelas</label>
                            <div style="display: flex; align-items: center;">
                                <span style="margin-right: 0.5rem;">R$</span>
                                <input type="number" id="precoPadrao3" step="0.01" min="0" placeholder="0.00" style="flex: 1; padding: 0.5rem;">
                                <span style="margin-left: 0.5rem;">/kg</span>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 120px 1fr; align-items: center; gap: 1rem;">
                            <label style="margin: 0; font-weight: 500;">‚≠ê‚≠ê‚≠ê‚≠ê 4 Estrelas</label>
                            <div style="display: flex; align-items: center;">
                                <span style="margin-right: 0.5rem;">R$</span>
                                <input type="number" id="precoPadrao4" step="0.01" min="0" placeholder="0.00" style="flex: 1; padding: 0.5rem;">
                                <span style="margin-left: 0.5rem;">/kg</span>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 120px 1fr; align-items: center; gap: 1rem;">
                            <label style="margin: 0; font-weight: 500;">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê 5 Estrelas</label>
                            <div style="display: flex; align-items: center;">
                                <span style="margin-right: 0.5rem;">R$</span>
                                <input type="number" id="precoPadrao5" step="0.01" min="0" placeholder="0.00" style="flex: 1; padding: 0.5rem;">
                                <span style="margin-left: 0.5rem;">/kg</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 1rem;">
                    <label>Descri√ß√£o</label>
                    <textarea id="descricao" rows="3" placeholder="Descri√ß√£o detalhada do tipo de lote"></textarea>
                </div>

                <div style="display: flex; gap: 0.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="fecharModalTipo()" style="flex: 1;">Cancelar</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Pre√ßos por Estrela -->
    <div class="modal" id="modalPrecos">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 id="tituloModalPrecos">Configurar Pre√ßos por Estrela</h2>
                <button class="modal-close" onclick="fecharModalPrecos()">&times;</button>
            </div>
            
            <div style="background: #f0f9ff; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                <h4 style="margin: 0 0 0.5rem 0; color: #0369a1;">
                    <i class="fas fa-tags"></i> <span id="nomeTipoPrecos"></span>
                </h4>
                <p style="margin: 0; color: #666; font-size: 0.9rem;">
                    Classifica√ß√£o: <strong id="classificacaoTipoPrecos"></strong>
                </p>
            </div>

            <form id="formPrecos">
                <input type="hidden" id="tipoIdPrecos">
                
                <div style="margin-bottom: 1.5rem;">
                    <p style="font-weight: 500; margin-bottom: 1rem;">Configure o pre√ßo por kg para cada n√≠vel de qualidade (estrelas):</p>
                    
                    <div style="display: grid; gap: 1rem;">
                        <div class="form-group" style="display: grid; grid-template-columns: 100px 1fr; align-items: center; gap: 1rem;">
                            <label style="margin: 0; display: flex; align-items: center;">
                                <i class="fas fa-star" style="color: #fbbf24;"></i>
                                <span style="margin-left: 0.5rem;">1 Estrela</span>
                            </label>
                            <div style="display: flex; align-items: center;">
                                <span style="margin-right: 0.5rem;">R$</span>
                                <input type="number" id="preco1" step="0.01" min="0" placeholder="0.00" style="flex: 1;">
                                <span style="margin-left: 0.5rem;">/kg</span>
                            </div>
                        </div>

                        <div class="form-group" style="display: grid; grid-template-columns: 100px 1fr; align-items: center; gap: 1rem;">
                            <label style="margin: 0; display: flex; align-items: center;">
                                <i class="fas fa-star" style="color: #fbbf24;"></i>
                                <i class="fas fa-star" style="color: #fbbf24;"></i>
                                <span style="margin-left: 0.5rem;">2 Estrelas</span>
                            </label>
                            <div style="display: flex; align-items: center;">
                                <span style="margin-right: 0.5rem;">R$</span>
                                <input type="number" id="preco2" step="0.01" min="0" placeholder="0.00" style="flex: 1;">
                                <span style="margin-left: 0.5rem;">/kg</span>
                            </div>
                        </div>

                        <div class="form-group" style="display: grid; grid-template-columns: 100px 1fr; align-items: center; gap: 1rem;">
                            <label style="margin: 0; display: flex; align-items: center;">
                                <i class="fas fa-star" style="color: #fbbf24;"></i>
                                <i class="fas fa-star" style="color: #fbbf24;"></i>
                                <i class="fas fa-star" style="color: #fbbf24;"></i>
                                <span style="margin-left: 0.5rem;">3 Estrelas</span>
                            </label>
                            <div style="display: flex; align-items: center;">
                                <span style="margin-right: 0.5rem;">R$</span>
                                <input type="number" id="preco3" step="0.01" min="0" placeholder="0.00" style="flex: 1;">
                                <span style="margin-left: 0.5rem;">/kg</span>
                            </div>
                        </div>

                        <div class="form-group" style="display: grid; grid-template-columns: 100px 1fr; align-items: center; gap: 1rem;">
                            <label style="margin: 0; display: flex; align-items: center;">
                                <i class="fas fa-star" style="color: #fbbf24;"></i>
                                <i class="fas fa-star" style="color: #fbbf24;"></i>
                                <i class="fas fa-star" style="color: #fbbf24;"></i>
                                <i class="fas fa-star" style="color: #fbbf24;"></i>
                                <span style="margin-left: 0.5rem;">4 Estrelas</span>
                            </label>
                            <div style="display: flex; align-items: center;">
                                <span style="margin-right: 0.5rem;">R$</span>
                                <input type="number" id="preco4" step="0.01" min="0" placeholder="0.00" style="flex: 1;">
                                <span style="margin-left: 0.5rem;">/kg</span>
                            </div>
                        </div>

                        <div class="form-group" style="display: grid; grid-template-columns: 100px 1fr; align-items: center; gap: 1rem;">
                            <label style="margin: 0; display: flex; align-items: center;">
                                <i class="fas fa-star" style="color: #fbbf24;"></i>
                                <i class="fas fa-star" style="color: #fbbf24;"></i>
                                <i class="fas fa-star" style="color: #fbbf24;"></i>
                                <i class="fas fa-star" style="color: #fbbf24;"></i>
                                <i class="fas fa-star" style="color: #fbbf24;"></i>
                                <span style="margin-left: 0.5rem;">5 Estrelas</span>
                            </label>
                            <div style="display: flex; align-items: center;">
                                <span style="margin-right: 0.5rem;">R$</span>
                                <input type="number" id="preco5" step="0.01" min="0" placeholder="0.00" style="flex: 1;">
                                <span style="margin-left: 0.5rem;">/kg</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 0.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="fecharModalPrecos()" style="flex: 1;">Cancelar</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Salvar Pre√ßos</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/static/js/auth.js"></script>
    <script>
        let tiposLote = [];

        function mostrarMensagem(mensagem, tipo = 'success') {
            alert(mensagem);
        }

        async function carregarTipos() {
            try {
                const response = await fetch('/api/tipos-lote', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) throw new Error('Erro ao carregar tipos de lote');

                tiposLote = await response.json();
                renderizarTabela();
            } catch (error) {
                console.error('Erro:', error);
                mostrarMensagem('Erro ao carregar tipos de lote', 'error');
            }
        }

        function renderizarTabela() {
            const tbody = document.getElementById('tabelaTipos');
            
            if (tiposLote.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem;">Nenhum tipo de lote cadastrado</td></tr>';
                return;
            }

            tbody.innerHTML = tiposLote.map(tipo => `
                <tr>
                    <td><strong>${tipo.codigo || '-'}</strong></td>
                    <td>${tipo.nome}</td>
                    <td>
                        <span class="badge badge-${tipo.classificacao === 'leve' ? 'success' : tipo.classificacao === 'media' ? 'warning' : 'danger'}">
                            ${tipo.classificacao === 'leve' ? 'ü™∂ Leve' : tipo.classificacao === 'media' ? '‚öñÔ∏è M√©dia' : '‚öì Pesada'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="abrirModalPrecos(${tipo.id})" title="Configurar pre√ßos">
                            <i class="fas fa-dollar-sign"></i> Configurar
                        </button>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="editarTipo(${tipo.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deletarTipo(${tipo.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function abrirModalNovoTipo() {
            document.getElementById('tituloModalTipo').textContent = 'Novo Tipo de Lote';
            document.getElementById('formTipo').reset();
            document.getElementById('tipoId').value = '';
            document.getElementById('modalTipo').style.display = 'flex';
        }

        function fecharModalTipo() {
            document.getElementById('modalTipo').style.display = 'none';
        }

        function editarTipo(id) {
            const tipo = tiposLote.find(t => t.id === id);
            if (!tipo) return;

            document.getElementById('tituloModalTipo').textContent = 'Editar Tipo de Lote';
            document.getElementById('tipoId').value = tipo.id;
            document.getElementById('nome').value = tipo.nome;
            document.getElementById('codigo').value = tipo.codigo || '';
            document.getElementById('classificacao').value = tipo.classificacao;
            document.getElementById('descricao').value = tipo.descricao || '';
            document.getElementById('modalTipo').style.display = 'flex';
        }

        document.getElementById('formTipo').addEventListener('submit', async (e) => {
            e.preventDefault();

            const tipoId = document.getElementById('tipoId').value;
            const dados = {
                nome: document.getElementById('nome').value,
                codigo: document.getElementById('codigo').value,
                classificacao: document.getElementById('classificacao').value,
                descricao: document.getElementById('descricao').value
            };

            try {
                const url = tipoId ? `/api/tipos-lote/${tipoId}` : '/api/tipos-lote';
                const method = tipoId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(dados)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.erro || 'Erro ao salvar');
                }

                mostrarMensagem(tipoId ? 'Tipo atualizado com sucesso!' : 'Tipo criado com sucesso!');
                fecharModalTipo();
                carregarTipos();
            } catch (error) {
                mostrarMensagem(error.message, 'error');
            }
        });

        async function deletarTipo(id) {
            if (!confirm('Tem certeza que deseja deletar este tipo de lote?')) return;

            try {
                const response = await fetch(`/api/tipos-lote/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.erro || 'Erro ao deletar');
                }

                mostrarMensagem('Tipo deletado com sucesso!');
                carregarTipos();
            } catch (error) {
                mostrarMensagem(error.message, 'error');
            }
        }

        async function abrirModalPrecos(tipoId) {
            const tipo = tiposLote.find(t => t.id === tipoId);
            if (!tipo) return;

            document.getElementById('tipoIdPrecos').value = tipoId;
            document.getElementById('nomeTipoPrecos').textContent = tipo.nome;
            document.getElementById('classificacaoTipoPrecos').textContent = 
                tipo.classificacao === 'leve' ? 'ü™∂ Leve' : 
                tipo.classificacao === 'media' ? '‚öñÔ∏è M√©dia' : '‚öì Pesada';

            for (let i = 1; i <= 5; i++) {
                document.getElementById(`preco${i}`).value = '';
            }

            try {
                const response = await fetch(`/api/tipos-lote/${tipoId}/precos`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    data.precos.forEach(preco => {
                        document.getElementById(`preco${preco.estrelas}`).value = preco.preco_por_kg || '';
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar pre√ßos:', error);
            }

            document.getElementById('modalPrecos').style.display = 'flex';
        }

        function fecharModalPrecos() {
            document.getElementById('modalPrecos').style.display = 'none';
        }

        document.getElementById('formPrecos').addEventListener('submit', async (e) => {
            e.preventDefault();

            const tipoId = document.getElementById('tipoIdPrecos').value;
            const precos = [];

            for (let estrelas = 1; estrelas <= 5; estrelas++) {
                const valor = document.getElementById(`preco${estrelas}`).value;
                if (valor) {
                    precos.push({
                        estrelas: estrelas,
                        preco_por_kg: parseFloat(valor),
                        ativo: true
                    });
                }
            }

            try {
                const response = await fetch(`/api/tipos-lote/${tipoId}/precos`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ precos })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.erro || 'Erro ao salvar pre√ßos');
                }

                mostrarMensagem('Pre√ßos configurados com sucesso!');
                fecharModalPrecos();
            } catch (error) {
                mostrarMensagem(error.message, 'error');
            }
        });

        async function importarExcel() {
            const fileInput = document.getElementById('fileExcel');
            const file = fileInput.files[0];

            if (!file) return;

            const formData = new FormData();
            formData.append('arquivo', file);

            try {
                const response = await fetch('/api/tipos-lote/importar-excel', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: formData
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.erro || 'Erro ao importar');
                }

                let mensagem = `Importa√ß√£o conclu√≠da!\n`;
                mensagem += `‚úÖ ${result.tipos_criados} tipo(s) criado(s)\n`;
                mensagem += `‚ôªÔ∏è ${result.tipos_atualizados} tipo(s) atualizado(s)`;
                
                if (result.erros && result.erros.length > 0) {
                    mensagem += `\n\n‚ö†Ô∏è ${result.erros.length} erro(s):\n`;
                    mensagem += result.erros.slice(0, 5).join('\n');
                    if (result.erros.length > 5) {
                        mensagem += `\n... e mais ${result.erros.length - 5} erro(s)`;
                    }
                }

                alert(mensagem);
                carregarTipos();
            } catch (error) {
                mostrarMensagem(error.message, 'error');
            } finally {
                fileInput.value = '';
            }
        }

        carregarTipos();
    </script>
</body>
</html>
