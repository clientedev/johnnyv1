<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administração - MRX Systems</title>
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#059669">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <header>
        <div class="header-content" style="justify-content: space-between;">
            <div class="logo">
                <img src="/static/images/mrx-logo.png" alt="MRX">
                <span>Administração</span>
            </div>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div class="notification-badge" onclick="window.location.href='/notificacoes.html'">
                    <i class="fas fa-bell"></i>
                    <span class="notification-count" id="headerNotificationCount" style="display: none;">0</span>
                </div>
                <button class="btn btn-secondary" onclick="logout()" style="font-size: 0.875rem; padding: 0.5rem 1rem;">Sair</button>
            </div>
        </div>
    </header>

    <!-- Bottom Navigation (Mobile) -->
    <nav class="bottom-nav" id="navMenuMobile">
        <!-- Menus serão renderizados dinamicamente pelo RBAC -->
    </nav>


    <main class="container mt-4">
        <h1 style="font-size: clamp(1.5rem, 6vw, 2rem); margin-bottom: var(--spacing-lg);">Painel de Administração</h1>

        <!-- Módulos do Sistema -->
        <div style="margin-bottom: var(--spacing-xl);">
            <h2 style="margin-bottom: var(--spacing-md); font-size: 1.25rem;">Módulos do Sistema</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-md);">
                
                <div class="card" style="cursor: pointer; transition: transform 0.2s;" onclick="window.location.href='/fornecedores.html'">
                    <div style="text-align: center; padding: var(--spacing-lg);">
                        <i class="fas fa-building" style="font-size: 3rem; color: var(--primary-color);"></i>
                        <h3 style="margin-top: var(--spacing-md); font-size: 1.1rem;">Fornecedores</h3>
                        <p style="color: #666; font-size: 0.9rem; margin-top: 0.5rem;">Gerenciar fornecedores e preços</p>
                    </div>
                </div>

                <div class="card" style="cursor: pointer; transition: transform 0.2s;" onclick="window.location.href='/solicitacoes.html'">
                    <div style="text-align: center; padding: var(--spacing-lg);">
                        <i class="fas fa-file-alt" style="font-size: 3rem; color: #059669;"></i>
                        <h3 style="margin-top: var(--spacing-md); font-size: 1.1rem;">Solicitações</h3>
                        <p style="color: #666; font-size: 0.9rem; margin-top: 0.5rem;">Aprovar/reprovar solicitações</p>
                    </div>
                </div>

                <div class="card" style="cursor: pointer; transition: transform 0.2s;" onclick="window.location.href='/lotes.html'">
                    <div style="text-align: center; padding: var(--spacing-lg);">
                        <i class="fas fa-boxes" style="font-size: 3rem; color: #3b82f6;"></i>
                        <h3 style="margin-top: var(--spacing-md); font-size: 1.1rem;">Lotes</h3>
                        <p style="color: #666; font-size: 0.9rem; margin-top: 0.5rem;">Gerenciar lotes de compra</p>
                    </div>
                </div>

                <div class="card" style="cursor: pointer; transition: transform 0.2s;" onclick="window.location.href='/entradas.html'">
                    <div style="text-align: center; padding: var(--spacing-lg);">
                        <i class="fas fa-warehouse" style="font-size: 3rem; color: #6366f1;"></i>
                        <h3 style="margin-top: var(--spacing-md); font-size: 1.1rem;">Entradas de Estoque</h3>
                        <p style="color: #666; font-size: 0.9rem; margin-top: 0.5rem;">Processar entradas de estoque</p>
                    </div>
                </div>

                <div class="card" style="cursor: pointer; transition: transform 0.2s;" onclick="window.location.href='/consulta.html'">
                    <div style="text-align: center; padding: var(--spacing-lg);">
                        <i class="fas fa-search" style="font-size: 3rem; color: #f59e0b;"></i>
                        <h3 style="margin-top: var(--spacing-md); font-size: 1.1rem;">Consulta Avançada</h3>
                        <p style="color: #666; font-size: 0.9rem; margin-top: 0.5rem;">Buscar e exportar dados</p>
                    </div>
                </div>

                <div class="card" style="cursor: pointer; transition: transform 0.2s;" onclick="window.location.href='/tipos-lote.html'">
                    <div style="text-align: center; padding: var(--spacing-lg);">
                        <i class="fas fa-tags" style="font-size: 3rem; color: #ec4899;"></i>
                        <h3 style="margin-top: var(--spacing-md); font-size: 1.1rem;">Tipos de Lote</h3>
                        <p style="color: #666; font-size: 0.9rem; margin-top: 0.5rem;">Gerenciar tipos e preços</p>
                    </div>
                </div>

                <div class="card" style="cursor: pointer; transition: transform 0.2s;" onclick="window.location.href='/configuracoes.html'">
                    <div style="text-align: center; padding: var(--spacing-lg);">
                        <i class="fas fa-sliders-h" style="font-size: 3rem; color: #8b5cf6;"></i>
                        <h3 style="margin-top: var(--spacing-md); font-size: 1.1rem;">Configurações</h3>
                        <p style="color: #666; font-size: 0.9rem; margin-top: 0.5rem;">Parâmetros do sistema</p>
                    </div>
                </div>

            </div>
        </div>

        <!-- Tabs de Navegação -->
        <h2 style="margin-bottom: var(--spacing-md); font-size: 1.25rem;">Gerenciamento de Usuários</h2>

        <!-- Funcionários -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-lg); flex-wrap: wrap; gap: var(--spacing-md);">
            <button class="btn btn-primary" onclick="abrirModalNovoFuncionario()">
                <i class="fas fa-plus"></i> Novo Funcionário
            </button>
        </div>

        <div class="card">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Email</th>
                            <th>Perfil</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaFuncionarios">
                        <tr><td colspan="4" class="loading">Carregando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Modal Novo Funcionário -->
    <div class="modal" id="modalNovoFuncionario">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Novo Funcionário</h2>
                <span class="modal-close" onclick="fecharModalNovoFuncionario()">&times;</span>
            </div>
            <form id="formNovoFuncionario">
                <div class="form-group">
                    <label>Nome</label>
                    <input type="text" id="nomeFuncionario" required>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="emailFuncionario" required>
                </div>
                <div class="form-group">
                    <label>Senha</label>
                    <input type="password" id="senhaFuncionario" required minlength="6">
                </div>
                <div class="form-group">
                    <label>Perfil</label>
                    <select id="perfilFuncionario" required>
                        <option value="">Selecione um perfil...</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary w-full">Criar Funcionário</button>
            </form>
        </div>
    </div>

    <!-- Modal Editar Funcionário -->
    <div class="modal" id="modalEditarFuncionario">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Editar Funcionário</h2>
                <span class="modal-close" onclick="fecharModalEditarFuncionario()">&times;</span>
            </div>
            <form id="formEditarFuncionario">
                <input type="hidden" id="editFuncionarioId">
                <div class="form-group">
                    <label>Nome</label>
                    <input type="text" id="editNomeFuncionario" required>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="editEmailFuncionario" required>
                </div>
                <div class="form-group">
                    <label>Nova Senha (deixe em branco para manter a atual)</label>
                    <input type="password" id="editSenhaFuncionario" minlength="6">
                </div>
                <div class="form-group">
                    <label>Perfil</label>
                    <select id="editPerfilFuncionario" required>
                        <option value="">Selecione um perfil...</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary w-full">Salvar Alterações</button>
            </form>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="/static/js/utils.js"></script>
    <script src="/static/js/rbac.js"></script>
    <script src="/static/js/app.js"></script>
    <script>
        let perfisDisponiveis = [];

        async function carregarPagina() {
            const user = await verificarAuth();
            if (!user) return;
            
            if (user.tipo !== 'admin') {
                showAlert('Acesso negado. Apenas administradores podem acessar esta página.');
                window.location.href = '/dashboard.html';
                return;
            }
            
            await carregarPerfis();
            await carregarFuncionarios();
            await atualizarNotificacoes();
        }

        async function carregarPerfis() {
            try {
                const response = await fetchAPI('/perfis');
                perfisDisponiveis = await response.json();
                
                const selectNovo = document.getElementById('perfilFuncionario');
                const selectEdit = document.getElementById('editPerfilFuncionario');
                
                const options = perfisDisponiveis
                    .filter(p => p.ativo)
                    .map(p => `<option value="${p.id}">${p.nome}</option>`)
                    .join('');
                
                selectNovo.innerHTML = '<option value="">Selecione um perfil...</option>' + options;
                selectEdit.innerHTML = '<option value="">Selecione um perfil...</option>' + options;
            } catch (error) {
                console.error('Erro ao carregar perfis:', error);
                showAlert('Erro ao carregar perfis');
            }
        }

        async function carregarFuncionarios() {
            const response = await fetchAPI('/usuarios');
            const funcionarios = await response.json();
            
            const tbody = document.getElementById('tabelaFuncionarios');
            
            if (funcionarios.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4">Nenhum funcionário cadastrado</td></tr>';
                return;
            }
            
            tbody.innerHTML = funcionarios.map(f => `
                <tr>
                    <td>${f.nome}</td>
                    <td>${f.email}</td>
                    <td><span class="badge ${f.perfil_nome === 'Administrador' ? 'badge-success' : 'badge-secondary'}">${f.perfil_nome || 'Sem perfil'}</span></td>
                    <td>
                        <button class="btn btn-small btn-secondary" onclick="editarFuncionario(${f.id})">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button class="btn btn-small btn-danger" onclick="excluirFuncionario(${f.id}, '${f.nome}')">
                            <i class="fas fa-trash"></i> Excluir
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function abrirModalNovoFuncionario() {
            document.getElementById('modalNovoFuncionario').style.display = 'flex';
        }

        function fecharModalNovoFuncionario() {
            document.getElementById('modalNovoFuncionario').style.display = 'none';
            document.getElementById('formNovoFuncionario').reset();
        }

        document.getElementById('formNovoFuncionario').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const perfilId = document.getElementById('perfilFuncionario').value;
            if (!perfilId) {
                showAlert('Por favor, selecione um perfil');
                return;
            }
            
            const dados = {
                nome: document.getElementById('nomeFuncionario').value,
                email: document.getElementById('emailFuncionario').value,
                senha: document.getElementById('senhaFuncionario').value,
                perfil_id: parseInt(perfilId)
            };
            
            try {
                await fetchAPI('/usuarios', {
                    method: 'POST',
                    body: JSON.stringify(dados)
                });
                
                showAlert('Funcionário criado com sucesso!');
                fecharModalNovoFuncionario();
                await carregarFuncionarios();
            } catch (error) {
                showAlert('Erro ao criar funcionário: ' + error.message);
            }
        });

        async function editarFuncionario(id) {
            const response = await fetchAPI(`/usuarios/${id}`);
            const funcionario = await response.json();
            
            document.getElementById('editFuncionarioId').value = funcionario.id;
            document.getElementById('editNomeFuncionario').value = funcionario.nome;
            document.getElementById('editEmailFuncionario').value = funcionario.email;
            document.getElementById('editPerfilFuncionario').value = funcionario.perfil_id || '';
            document.getElementById('editSenhaFuncionario').value = '';
            
            document.getElementById('modalEditarFuncionario').style.display = 'flex';
        }

        function fecharModalEditarFuncionario() {
            document.getElementById('modalEditarFuncionario').style.display = 'none';
            document.getElementById('formEditarFuncionario').reset();
        }

        document.getElementById('formEditarFuncionario').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const perfilId = document.getElementById('editPerfilFuncionario').value;
            if (!perfilId) {
                showAlert('Por favor, selecione um perfil');
                return;
            }
            
            const id = document.getElementById('editFuncionarioId').value;
            const dados = {
                nome: document.getElementById('editNomeFuncionario').value,
                email: document.getElementById('editEmailFuncionario').value,
                perfil_id: parseInt(perfilId)
            };
            
            const novaSenha = document.getElementById('editSenhaFuncionario').value;
            if (novaSenha) {
                dados.senha = novaSenha;
            }
            
            try {
                await fetchAPI(`/usuarios/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(dados)
                });
                
                showAlert('Funcionário atualizado com sucesso!');
                fecharModalEditarFuncionario();
                await carregarFuncionarios();
            } catch (error) {
                showAlert('Erro ao atualizar funcionário: ' + error.message);
            }
        });

        async function excluirFuncionario(id, nome) {
            if (!confirm(`Tem certeza que deseja excluir o funcionário ${nome}?`)) {
                return;
            }
            
            try {
                await fetchAPI(`/usuarios/${id}`, {
                    method: 'DELETE'
                });
                
                showAlert('Funcionário excluído com sucesso!');
                await carregarFuncionarios();
            } catch (error) {
                showAlert('Erro ao excluir funcionário: ' + error.message);
            }
        }

        carregarPagina();
    </script>
</body>
</html>
