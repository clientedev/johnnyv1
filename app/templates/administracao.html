<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administra√ß√£o - MRX Systems</title>
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#059669">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <header>
        <div class="header-content" style="justify-content: space-between;">
            <div class="logo">
                <img src="/static/images/mrx-logo.png" alt="MRX">
                <span>Administra√ß√£o</span>
            </div>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div class="notification-badge" onclick="window.location.href='/notificacoes.html'">
                    <i class="fas fa-bell"></i>
                    <span class="notification-count" id="headerNotificationCount" style="display: none;">0</span>
                </div>
                <button class="btn btn-secondary" onclick="logout()" style="font-size: 0.875rem; padding: 0.5rem 1rem;">Sair</button>
            </div>
        </div>
    </header>

    <!-- Bottom Navigation (Mobile) -->
    <nav class="bottom-nav" id="navMenuMobile">
        <!-- Menus ser√£o renderizados dinamicamente pelo RBAC -->
    </nav>


    <main class="container mt-4">
        <h1 style="font-size: clamp(1.5rem, 6vw, 2rem); margin-bottom: var(--spacing-lg);">Painel de Administra√ß√£o</h1>

        <!-- M√≥dulos do Sistema -->
        <div style="margin-bottom: var(--spacing-xl);">
            <h2 style="margin-bottom: var(--spacing-md); font-size: 1.25rem;">M√≥dulos do Sistema</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-md);">
                
                <div class="card" style="cursor: pointer; transition: transform 0.2s;" onclick="window.location.href='/fornecedores.html'">
                    <div style="text-align: center; padding: var(--spacing-lg);">
                        <i class="fas fa-building" style="font-size: 3rem; color: var(--primary-color);"></i>
                        <h3 style="margin-top: var(--spacing-md); font-size: 1.1rem;">Fornecedores</h3>
                        <p style="color: #666; font-size: 0.9rem; margin-top: 0.5rem;">Gerenciar fornecedores e pre√ßos</p>
                    </div>
                </div>

                <div class="card" style="cursor: pointer; transition: transform 0.2s;" onclick="window.location.href='/solicitacoes.html'">
                    <div style="text-align: center; padding: var(--spacing-lg);">
                        <i class="fas fa-file-alt" style="font-size: 3rem; color: #059669;"></i>
                        <h3 style="margin-top: var(--spacing-md); font-size: 1.1rem;">Solicita√ß√µes</h3>
                        <p style="color: #666; font-size: 0.9rem; margin-top: 0.5rem;">Aprovar/reprovar solicita√ß√µes</p>
                    </div>
                </div>

                <div class="card" style="cursor: pointer; transition: transform 0.2s;" onclick="window.location.href='/lotes.html'">
                    <div style="text-align: center; padding: var(--spacing-lg);">
                        <i class="fas fa-boxes" style="font-size: 3rem; color: #3b82f6;"></i>
                        <h3 style="margin-top: var(--spacing-md); font-size: 1.1rem;">Lotes</h3>
                        <p style="color: #666; font-size: 0.9rem; margin-top: 0.5rem;">Gerenciar lotes de compra</p>
                    </div>
                </div>

                <div class="card" style="cursor: pointer; transition: transform 0.2s;" onclick="window.location.href='/tipos-lote.html'">
                    <div style="text-align: center; padding: var(--spacing-lg);">
                        <i class="fas fa-tags" style="font-size: 3rem; color: #ec4899;"></i>
                        <h3 style="margin-top: var(--spacing-md); font-size: 1.1rem;">Materiais e Pre√ßos</h3>
                        <p style="color: #666; font-size: 0.9rem; margin-top: 0.5rem;">Gerenciar materiais e tabelas de pre√ßo</p>
                    </div>
                </div>

                <div class="card" style="cursor: pointer; transition: transform 0.2s;" onclick="window.location.href='/logistica.html'">
                    <div style="text-align: center; padding: var(--spacing-lg);">
                        <i class="fas fa-truck" style="font-size: 3rem; color: #10b981;"></i>
                        <h3 style="margin-top: var(--spacing-md); font-size: 1.1rem;">Log√≠stica</h3>
                        <p style="color: #666; font-size: 0.9rem; margin-top: 0.5rem;">Ordens de Servi√ßo e rastreamento</p>
                    </div>
                </div>

                <div class="card" style="cursor: pointer; transition: transform 0.2s;" onclick="window.location.href='/conferencia.html'">
                    <div style="text-align: center; padding: var(--spacing-lg);">
                        <i class="fas fa-clipboard-check" style="font-size: 3rem; color: #14b8a6;"></i>
                        <h3 style="margin-top: var(--spacing-md); font-size: 1.1rem;">Confer√™ncia</h3>
                        <p style="color: #666; font-size: 0.9rem; margin-top: 0.5rem;">Confer√™ncia de recebimento</p>
                    </div>
                </div>

                <div class="card" style="cursor: pointer; transition: transform 0.2s;" onclick="window.location.href='/veiculos.html'">
                    <div style="text-align: center; padding: var(--spacing-lg);">
                        <i class="fas fa-car" style="font-size: 3rem; color: #f97316;"></i>
                        <h3 style="margin-top: var(--spacing-md); font-size: 1.1rem;">Ve√≠culos</h3>
                        <p style="color: #666; font-size: 0.9rem; margin-top: 0.5rem;">Gerenciar frota de ve√≠culos</p>
                    </div>
                </div>

                <div class="card" style="cursor: pointer; transition: transform 0.2s;" onclick="window.location.href='/motoristas.html'">
                    <div style="text-align: center; padding: var(--spacing-lg);">
                        <i class="fas fa-user-tie" style="font-size: 3rem; color: #06b6d4;"></i>
                        <h3 style="margin-top: var(--spacing-md); font-size: 1.1rem;">Motoristas</h3>
                        <p style="color: #666; font-size: 0.9rem; margin-top: 0.5rem;">Gerenciar motoristas e credenciais</p>
                    </div>
                </div>

                <div class="card" style="cursor: pointer; transition: transform 0.2s;" onclick="window.location.href='/separacao-fila.html'">
                    <div style="text-align: center; padding: var(--spacing-lg);">
                        <i class="fas fa-list-ol" style="font-size: 3rem; color: #ef4444;"></i>
                        <h3 style="margin-top: var(--spacing-md); font-size: 1.1rem;">Fila de Separa√ß√£o</h3>
                        <p style="color: #666; font-size: 0.9rem; margin-top: 0.5rem;">Gerenciar fila de separa√ß√£o</p>
                    </div>
                </div>

                <div class="card" style="cursor: pointer; transition: transform 0.2s;" onclick="window.location.href='/residuos-aprovacao.html'">
                    <div style="text-align: center; padding: var(--spacing-lg);">
                        <i class="fas fa-recycle" style="font-size: 3rem; color: #22c55e;"></i>
                        <h3 style="margin-top: var(--spacing-md); font-size: 1.1rem;">Aprova√ß√£o de Res√≠duos</h3>
                        <p style="color: #666; font-size: 0.9rem; margin-top: 0.5rem;">Aprovar e gerenciar res√≠duos</p>
                    </div>
                </div>

                <div class="card" style="cursor: pointer; transition: transform 0.2s; position: relative;" onclick="window.location.href='/revisao-tabelas-admin.html'">
                    <div id="badgeTabelasPendentes" style="display: none; position: absolute; top: 10px; right: 10px; background: #ef4444; color: white; font-size: 0.75rem; font-weight: 700; padding: 0.25rem 0.5rem; border-radius: 9999px; min-width: 24px; text-align: center;"></div>
                    <div style="text-align: center; padding: var(--spacing-lg);">
                        <i class="fas fa-file-invoice-dollar" style="font-size: 3rem; color: #f97316;"></i>
                        <h3 style="margin-top: var(--spacing-md); font-size: 1.1rem;">Tabelas de Precos</h3>
                        <p style="color: #666; font-size: 0.9rem; margin-top: 0.5rem;">Revisar tabelas de fornecedores</p>
                    </div>
                </div>

                <div class="card" style="cursor: pointer; transition: transform 0.2s;" onclick="abrirModalEmDesenvolvimento('RH')">
                    <div style="text-align: center; padding: var(--spacing-lg);">
                        <i class="fas fa-users" style="font-size: 3rem; color: #8b5cf6;"></i>
                        <h3 style="margin-top: var(--spacing-md); font-size: 1.1rem;">RH</h3>
                        <p style="color: #666; font-size: 0.9rem; margin-top: 0.5rem;">Recursos Humanos</p>
                    </div>
                </div>

                <div class="card" style="cursor: pointer; transition: transform 0.2s;" onclick="abrirModalEmDesenvolvimento('Contas a Pagar')">
                    <div style="text-align: center; padding: var(--spacing-lg);">
                        <i class="fas fa-money-bill-wave" style="font-size: 3rem; color: #dc2626;"></i>
                        <h3 style="margin-top: var(--spacing-md); font-size: 1.1rem;">Contas a Pagar</h3>
                        <p style="color: #666; font-size: 0.9rem; margin-top: 0.5rem;">Gest√£o de pagamentos</p>
                    </div>
                </div>

                <div class="card" style="cursor: pointer; transition: transform 0.2s;" onclick="abrirModalEmDesenvolvimento('Contas a Receber')">
                    <div style="text-align: center; padding: var(--spacing-lg);">
                        <i class="fas fa-hand-holding-usd" style="font-size: 3rem; color: #16a34a;"></i>
                        <h3 style="margin-top: var(--spacing-md); font-size: 1.1rem;">Contas a Receber</h3>
                        <p style="color: #666; font-size: 0.9rem; margin-top: 0.5rem;">Gest√£o de recebimentos</p>
                    </div>
                </div>

            </div>
        </div>

        <!-- Atribui√ß√£o de Compradores a Fornecedores -->
        <h2 style="margin-bottom: var(--spacing-md); font-size: 1.25rem; margin-top: 2rem;">Atribui√ß√£o de Compradores</h2>
        
        <div class="card">
            <div style="margin-bottom: 1rem;">
                <p style="color: #666; font-size: 0.9rem;">Atribua compradores respons√°veis para cada fornecedor. Apenas compradores poder√£o ver e criar solicita√ß√µes para os fornecedores atribu√≠dos a eles.</p>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <input type="text" id="buscaFornecedor" placeholder="üîç Buscar fornecedor..." style="width: 100%; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 8px;" onkeyup="filtrarFornecedores()">
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Fornecedor</th>
                            <th>CNPJ/CPF</th>
                            <th>Comprador Respons√°vel</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaAtribuicoes">
                        <tr><td colspan="4" class="loading">Carregando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tabs de Navega√ß√£o -->
        <h2 style="margin-bottom: var(--spacing-md); font-size: 1.25rem; margin-top: 2rem;">Gerenciamento de Usu√°rios</h2>

        <!-- Funcion√°rios -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-lg); flex-wrap: wrap; gap: var(--spacing-md);">
            <button class="btn btn-primary" onclick="abrirModalNovoFuncionario()">
                <i class="fas fa-plus"></i> Novo Funcion√°rio
            </button>
        </div>

        <div class="card">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Email</th>
                            <th>Perfil</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaFuncionarios">
                        <tr><td colspan="4" class="loading">Carregando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Modal Novo Funcion√°rio -->
    <div class="modal" id="modalNovoFuncionario">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Novo Funcion√°rio</h2>
                <span class="modal-close" onclick="fecharModalNovoFuncionario()">&times;</span>
            </div>
            <form id="formNovoFuncionario">
                <div class="form-group">
                    <label>Nome</label>
                    <input type="text" id="nomeFuncionario" required>
                </div>
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" id="emailFuncionario" required>
                </div>
                <div class="form-group">
                    <label>Senha (deixe vazio para usar √∫ltimos 4 d√≠gitos do CPF)</label>
                    <input type="password" id="senhaFuncionario" minlength="6">
                </div>
                <div class="form-group">
                    <label>Perfil</label>
                    <select id="perfilFuncionario" required>
                        <option value="">Selecione um perfil...</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary w-full">Criar Funcion√°rio</button>
            </form>
        </div>
    </div>

    <!-- Modal Editar Funcion√°rio -->
    <div class="modal" id="modalEditarFuncionario">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Editar Funcion√°rio</h2>
                <span class="modal-close" onclick="fecharModalEditarFuncionario()">&times;</span>
            </div>
            <form id="formEditarFuncionario">
                <input type="hidden" id="editFuncionarioId">
                <div class="form-group">
                    <label>Nome</label>
                    <input type="text" id="editNomeFuncionario" required>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="editEmailFuncionario" required>
                </div>
                <div class="form-group">
                    <label>Nova Senha (deixe em branco para manter a atual)</label>
                    <input type="password" id="editSenhaFuncionario" minlength="6">
                </div>
                <div class="form-group">
                    <label>Perfil</label>
                    <select id="editPerfilFuncionario" required>
                        <option value="">Selecione um perfil...</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary w-full">Salvar Altera√ß√µes</button>
            </form>
        </div>
    </div>

    <!-- Modal Atribuir Comprador -->
    <div class="modal" id="modalAtribuirComprador">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Atribuir Comprador</h2>
                <span class="modal-close" onclick="fecharModalAtribuirComprador()">&times;</span>
            </div>
            <form id="formAtribuirComprador">
                <input type="hidden" id="fornecedorIdAtribuir">
                <div class="form-group">
                    <label>Fornecedor</label>
                    <input type="text" id="fornecedorNomeAtribuir" readonly style="background: #f3f4f6;">
                </div>
                <div class="form-group">
                    <label>Comprador Respons√°vel</label>
                    <select id="compradorSelect" required>
                        <option value="">Selecione um comprador...</option>
                    </select>
                </div>
                <div style="display: flex; gap: 0.75rem;">
                    <button type="button" class="btn btn-secondary" onclick="fecharModalAtribuirComprador()" style="flex: 1;">Cancelar</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Atribuir</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Em Desenvolvimento -->
    <div class="modal" id="modalEmDesenvolvimento">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header" style="border-bottom: none; padding-bottom: 0;">
                <span class="modal-close" onclick="fecharModalEmDesenvolvimento()">&times;</span>
            </div>
            <div style="text-align: center; padding: 2rem 1.5rem;">
                <div style="display: inline-block; padding: 1.5rem; background: linear-gradient(135deg, #059669 0%, #10b981 100%); border-radius: 50%; margin-bottom: 1.5rem;">
                    <i class="fas fa-tools" style="font-size: 3rem; color: white;"></i>
                </div>
                <h2 style="margin-bottom: 1rem; color: #1f2937; font-size: 1.75rem;">M√≥dulo em Desenvolvimento</h2>
                <p style="color: #6b7280; font-size: 1.125rem; margin-bottom: 0.5rem; font-weight: 500;" id="nomeModuloDesenvolvimento"></p>
                <p style="color: #9ca3af; font-size: 0.95rem; line-height: 1.6; margin-bottom: 2rem;">
                    Esta funcionalidade est√° sendo desenvolvida e em breve estar√° dispon√≠vel para uso. 
                    Agradecemos sua paci√™ncia!
                </p>
                <div style="display: flex; gap: 0.75rem; align-items: center; justify-content: center; padding: 1rem; background: #f3f4f6; border-radius: 0.5rem; margin-bottom: 1.5rem;">
                    <i class="fas fa-info-circle" style="color: #059669; font-size: 1.25rem;"></i>
                    <p style="color: #4b5563; font-size: 0.875rem; margin: 0;">
                        Em caso de d√∫vidas, entre em contato com o suporte
                    </p>
                </div>
                <button class="btn btn-primary" onclick="fecharModalEmDesenvolvimento()" style="padding: 0.75rem 2rem; font-size: 1rem;">
                    <i class="fas fa-check"></i> Entendi
                </button>
            </div>
        </div>
    </div>

    <style>
        /* Padding espec√≠fico para mobile e desktop na p√°gina de administra√ß√£o */
        @media (max-width: 767px) {
            main.container {
                padding-top: 60px !important;
            }
        }
        
        @media (min-width: 768px) {
            main.container {
                padding-top: 50px !important;
            }
        }
    </style>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="/static/js/utils.js"></script>
    <script src="/static/js/rbac.js"></script>
    <script src="/static/js/app.js"></script>
    <script>
        let perfisDisponiveis = [];
        let fornecedoresList = [];
        let compradores = [];

        async function carregarPagina() {
            const user = await verificarAuth();
            if (!user) return;
            
            if (user.tipo !== 'admin') {
                showAlert('Acesso negado. Apenas administradores podem acessar esta p√°gina.');
                window.location.href = '/dashboard.html';
                return;
            }
            
            await carregarPerfis();
            await carregarFuncionarios();
            await carregarCompradores();
            await carregarAtribuicoes();
            await carregarTabelasPendentes();
            await atualizarNotificacoes();
        }

        async function carregarTabelasPendentes() {
            try {
                const response = await fetchAPI('/fornecedor-tabela-precos/pendentes');
                if (response.ok) {
                    const pendentes = await response.json();
                    const badge = document.getElementById('badgeTabelasPendentes');
                    if (pendentes && pendentes.length > 0) {
                        badge.textContent = pendentes.length;
                        badge.style.display = 'block';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar tabelas pendentes:', error);
            }
        }

        async function carregarCompradores() {
            try {
                const response = await fetchAPI('/usuarios');
                const usuarios = await response.json();
                
                // Filtrar apenas compradores (perfil Comprador (PJ))
                compradores = usuarios.filter(u => u.perfil_nome && u.perfil_nome.includes('Comprador'));
                
                const select = document.getElementById('compradorSelect');
                select.innerHTML = '<option value="">Selecione um comprador...</option>';
                compradores.forEach(c => {
                    select.innerHTML += `<option value="${c.id}">${c.nome}</option>`;
                });
            } catch (error) {
                console.error('Erro ao carregar compradores:', error);
            }
        }

        async function carregarAtribuicoes() {
            try {
                const response = await fetchAPI('/fornecedores');
                if (!response || !response.ok) {
                    throw new Error('Erro ao buscar fornecedores');
                }
                fornecedoresList = await response.json();
                
                console.log('Fornecedores carregados:', fornecedoresList);
                renderizarAtribuicoes(fornecedoresList);
            } catch (error) {
                console.error('Erro ao carregar atribui√ß√µes:', error);
                document.getElementById('tabelaAtribuicoes').innerHTML = '<tr><td colspan="4">Erro ao carregar dados</td></tr>';
            }
        }

        function renderizarAtribuicoes(fornecedores) {
            const tbody = document.getElementById('tabelaAtribuicoes');
            
            if (fornecedores.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4">Nenhum fornecedor cadastrado</td></tr>';
                return;
            }
            
            tbody.innerHTML = fornecedores.map(f => {
                const doc = f.cnpj ? formatarCNPJ(f.cnpj) : (f.cpf ? formatarCPF(f.cpf) : 'N/A');
                const comprador = f.comprador_responsavel_nome || '<span style="color: #9ca3af;">N√£o atribu√≠do</span>';
                
                console.log(`Fornecedor ${f.nome}: comprador_responsavel_id=${f.comprador_responsavel_id}, comprador_responsavel_nome=${f.comprador_responsavel_nome}`);
                
                return `
                    <tr data-fornecedor-id="${f.id}">
                        <td>${f.nome}</td>
                        <td>${doc}</td>
                        <td id="comprador-${f.id}">${comprador}</td>
                        <td>
                            <button class="btn btn-small btn-primary" onclick="abrirModalAtribuir(${f.id}, '${f.nome.replace(/'/g, "\\'")}')">
                                <i class="fas fa-user-plus"></i> ${f.comprador_responsavel_id ? 'Alterar' : 'Atribuir'}
                            </button>
                            ${f.comprador_responsavel_id ? `
                                <button class="btn btn-small btn-danger" onclick="removerAtribuicao(${f.id}, '${f.nome.replace(/'/g, "\\'")}')">
                                    <i class="fas fa-times"></i> Remover
                                </button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function formatarCNPJ(cnpj) {
            if (!cnpj) return '';
            const numeros = cnpj.replace(/\D/g, '');
            return numeros.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/, '$1.$2.$3/$4-$5');
        }

        function formatarCPF(cpf) {
            if (!cpf) return '';
            const numeros = cpf.replace(/\D/g, '');
            return numeros.replace(/^(\d{3})(\d{3})(\d{3})(\d{2})$/, '$1.$2.$3-$4');
        }

        function filtrarFornecedores() {
            const busca = document.getElementById('buscaFornecedor').value.toLowerCase();
            const filtrados = fornecedoresList.filter(f => 
                f.nome.toLowerCase().includes(busca) ||
                (f.cnpj && f.cnpj.includes(busca)) ||
                (f.cpf && f.cpf.includes(busca))
            );
            renderizarAtribuicoes(filtrados);
        }

        function abrirModalAtribuir(fornecedorId, fornecedorNome) {
            const fornecedor = fornecedoresList.find(f => f.id === fornecedorId);
            
            document.getElementById('fornecedorIdAtribuir').value = fornecedorId;
            document.getElementById('fornecedorNomeAtribuir').value = fornecedorNome;
            document.getElementById('compradorSelect').value = fornecedor.comprador_responsavel_id || '';
            
            document.getElementById('modalAtribuirComprador').style.display = 'flex';
        }

        function fecharModalAtribuirComprador() {
            document.getElementById('modalAtribuirComprador').style.display = 'none';
        }

        document.getElementById('formAtribuirComprador').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fornecedorId = document.getElementById('fornecedorIdAtribuir').value;
            const compradorId = document.getElementById('compradorSelect').value;
            
            if (!compradorId) {
                showAlert('Selecione um comprador');
                return;
            }
            
            try {
                const response = await fetchAPI(`/fornecedores/${fornecedorId}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        comprador_responsavel_id: parseInt(compradorId)
                    })
                });
                
                if (response && response.ok) {
                    showAlert('Comprador atribu√≠do com sucesso!', 'success');
                    fecharModalAtribuirComprador();
                    // Recarregar a lista de fornecedores para atualizar a tabela
                    await carregarAtribuicoes();
                } else {
                    const errorData = await response.json();
                    showAlert('Erro ao atribuir comprador: ' + (errorData.erro || 'Erro desconhecido'));
                }
            } catch (error) {
                showAlert('Erro ao atribuir comprador: ' + error.message);
            }
        });

        async function removerAtribuicao(fornecedorId, fornecedorNome) {
            if (!confirm(`Remover atribui√ß√£o de comprador do fornecedor "${fornecedorNome}"?`)) {
                return;
            }
            
            try {
                await fetchAPI(`/fornecedores/${fornecedorId}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        comprador_responsavel_id: null
                    })
                });
                
                showAlert('Atribui√ß√£o removida com sucesso!');
                await carregarAtribuicoes();
            } catch (error) {
                showAlert('Erro ao remover atribui√ß√£o: ' + error.message);
            }
        }

        async function carregarPerfis() {
            try {
                const response = await fetchAPI('/perfis');
                perfisDisponiveis = await response.json();
                
                const selectNovo = document.getElementById('perfilFuncionario');
                const selectEdit = document.getElementById('editPerfilFuncionario');
                
                const options = perfisDisponiveis
                    .filter(p => p.ativo)
                    .map(p => `<option value="${p.id}">${p.nome}</option>`)
                    .join('');
                
                selectNovo.innerHTML = '<option value="">Selecione um perfil...</option>' + options;
                selectEdit.innerHTML = '<option value="">Selecione um perfil...</option>' + options;
            } catch (error) {
                console.error('Erro ao carregar perfis:', error);
                showAlert('Erro ao carregar perfis');
            }
        }

        async function carregarFuncionarios() {
            const response = await fetchAPI('/usuarios');
            const funcionarios = await response.json();
            
            const tbody = document.getElementById('tabelaFuncionarios');
            
            if (funcionarios.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4">Nenhum funcion√°rio cadastrado</td></tr>';
                return;
            }
            
            tbody.innerHTML = funcionarios.map(f => `
                <tr>
                    <td>${f.nome}</td>
                    <td>${f.email}</td>
                    <td><span class="badge ${f.perfil_nome === 'Administrador' ? 'badge-success' : 'badge-secondary'}">${f.perfil_nome || 'Sem perfil'}</span></td>
                    <td>
                        <button class="btn btn-small btn-secondary" onclick="editarFuncionario(${f.id})">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button class="btn btn-small btn-danger" onclick="excluirFuncionario(${f.id}, '${f.nome}')">
                            <i class="fas fa-trash"></i> Excluir
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function abrirModalNovoFuncionario() {
            document.getElementById('modalNovoFuncionario').style.display = 'flex';
        }

        function fecharModalNovoFuncionario() {
            document.getElementById('modalNovoFuncionario').style.display = 'none';
            document.getElementById('formNovoFuncionario').reset();
        }

        document.getElementById('formNovoFuncionario').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const perfilId = document.getElementById('perfilFuncionario').value;
            if (!perfilId) {
                showAlert('Por favor, selecione um perfil');
                return;
            }
            
            const dados = {
                nome: document.getElementById('nomeFuncionario').value,
                email: document.getElementById('emailFuncionario').value,
                senha: document.getElementById('senhaFuncionario').value,
                perfil_id: parseInt(perfilId)
            };
            
            try {
                await fetchAPI('/usuarios', {
                    method: 'POST',
                    body: JSON.stringify(dados)
                });
                
                showAlert('Funcion√°rio criado com sucesso!');
                fecharModalNovoFuncionario();
                await carregarFuncionarios();
            } catch (error) {
                showAlert('Erro ao criar funcion√°rio: ' + error.message);
            }
        });

        async function editarFuncionario(id) {
            const response = await fetchAPI(`/usuarios/${id}`);
            const funcionario = await response.json();
            
            document.getElementById('editFuncionarioId').value = funcionario.id;
            document.getElementById('editNomeFuncionario').value = funcionario.nome;
            document.getElementById('editEmailFuncionario').value = funcionario.email;
            document.getElementById('editPerfilFuncionario').value = funcionario.perfil_id || '';
            document.getElementById('editSenhaFuncionario').value = '';
            
            document.getElementById('modalEditarFuncionario').style.display = 'flex';
        }

        function fecharModalEditarFuncionario() {
            document.getElementById('modalEditarFuncionario').style.display = 'none';
            document.getElementById('formEditarFuncionario').reset();
        }

        document.getElementById('formEditarFuncionario').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const perfilId = document.getElementById('editPerfilFuncionario').value;
            if (!perfilId) {
                showAlert('Por favor, selecione um perfil');
                return;
            }
            
            const id = document.getElementById('editFuncionarioId').value;
            const dados = {
                nome: document.getElementById('editNomeFuncionario').value,
                email: document.getElementById('editEmailFuncionario').value,
                perfil_id: parseInt(perfilId)
            };
            
            const novaSenha = document.getElementById('editSenhaFuncionario').value;
            if (novaSenha) {
                dados.senha = novaSenha;
            }
            
            try {
                await fetchAPI(`/usuarios/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(dados)
                });
                
                showAlert('Funcion√°rio atualizado com sucesso!');
                fecharModalEditarFuncionario();
                await carregarFuncionarios();
            } catch (error) {
                showAlert('Erro ao atualizar funcion√°rio: ' + error.message);
            }
        });

        async function excluirFuncionario(id, nome) {
            if (!confirm(`Tem certeza que deseja excluir o funcion√°rio ${nome}?`)) {
                return;
            }
            
            try {
                await fetchAPI(`/usuarios/${id}`, {
                    method: 'DELETE'
                });
                
                showAlert('Funcion√°rio exclu√≠do com sucesso!');
                await carregarFuncionarios();
            } catch (error) {
                showAlert('Erro ao excluir funcion√°rio: ' + error.message);
            }
        }

        function abrirModalEmDesenvolvimento(nomeModulo) {
            document.getElementById('nomeModuloDesenvolvimento').textContent = nomeModulo;
            document.getElementById('modalEmDesenvolvimento').style.display = 'flex';
        }

        function fecharModalEmDesenvolvimento() {
            document.getElementById('modalEmDesenvolvimento').style.display = 'none';
        }

        carregarPagina();
    </script>
</body>
</html>
