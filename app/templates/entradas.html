<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entradas - MRX Systems</title>
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#059669">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">
                <img src="/static/images/mrx-logo.png" alt="MRX">
                <span>Entradas</span>
            </div>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div class="notification-badge" onclick="window.location.href='/notificacoes.html'">
                    <i class="fas fa-bell"></i>
                    <span class="notification-count" id="headerNotificationCount" style="display: none;">0</span>
                </div>
                <button class="btn btn-secondary" onclick="logout()">Sair</button>
            </div>
        </div>
    </header>

    <nav class="bottom-nav">
        <a href="/administracao.html" class="bottom-nav-item">
            <i class="fas fa-cog icon"></i>
            <span>Admin</span>
        </a>
        <a href="/dashboard.html" class="bottom-nav-item">
            <i class="fas fa-chart-line icon"></i>
            <span>Dashboard</span>
        </a>
        <a href="/entradas.html" class="bottom-nav-item active">
            <i class="fas fa-inbox icon"></i>
            <span>Entradas</span>
        </a>
        <a href="/solicitacoes.html" class="bottom-nav-item">
            <i class="fas fa-file-alt icon"></i>
            <span>Solicitações</span>
        </a>
        <a href="/empresas.html" class="bottom-nav-item">
            <i class="fas fa-building icon"></i>
            <span>Empresas</span>
        </a>
    </nav>

    <main class="container mt-4">
        <h1>Entradas de Placas</h1>
        <p>Aprove ou reprove lotes de placas das solicitações confirmadas</p>

        <div class="filter-section" style="margin-bottom: var(--spacing-lg);">
            <select id="filtroStatus" onchange="filtrarEntradas()">
                <option value="">Todos os status</option>
                <option value="pendente" selected>Pendente</option>
                <option value="aprovada">Aprovada</option>
                <option value="reprovada">Reprovada</option>
            </select>
        </div>

        <div id="listaEntradas" class="grid-container"></div>
    </main>

    <script>
        let entradas = [];
        
        async function carregarEntradas() {
            try {
                const token = localStorage.getItem('token');
                const status = document.getElementById('filtroStatus').value;
                
                const url = status ? `/api/entradas?status=${status}` : '/api/entradas';
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    entradas = await response.json();
                    exibirEntradas();
                }
            } catch (error) {
                console.error('Erro ao carregar entradas:', error);
            }
        }

        function exibirEntradas() {
            const lista = document.getElementById('listaEntradas');
            
            if (entradas.length === 0) {
                lista.innerHTML = '<p style="text-align: center; padding: 2rem;">Nenhuma entrada encontrada.</p>';
                return;
            }

            lista.innerHTML = entradas.map(entrada => `
                <div class="card">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3>Entrada #${entrada.id}</h3>
                        <span class="badge badge-${entrada.status === 'aprovada' ? 'success' : entrada.status === 'reprovada' ? 'danger' : 'warning'}">
                            ${entrada.status.toUpperCase()}
                        </span>
                    </div>
                    <div class="card-body">
                        <p><strong>Solicitação:</strong> #${entrada.solicitacao.id}</p>
                        <p><strong>Empresa:</strong> ${entrada.solicitacao.empresa_nome}</p>
                        <p><strong>Funcionário:</strong> ${entrada.solicitacao.funcionario_nome}</p>
                        <p><strong>Total de Placas:</strong> ${entrada.placas ? entrada.placas.length : 0}</p>
                        <p><strong>Data de Entrada:</strong> ${new Date(entrada.data_entrada).toLocaleString('pt-BR')}</p>
                        ${entrada.data_processamento ? `<p><strong>Processado em:</strong> ${new Date(entrada.data_processamento).toLocaleString('pt-BR')}</p>` : ''}
                        ${entrada.observacoes ? `<p><strong>Observações:</strong> ${entrada.observacoes}</p>` : ''}
                    </div>
                    ${entrada.status === 'pendente' ? `
                        <div class="card-footer" style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-success" onclick="aprovarEntrada(${entrada.id})" style="flex: 1;">
                                <i class="fas fa-check"></i> Aprovar
                            </button>
                            <button class="btn btn-danger" onclick="reprovarEntrada(${entrada.id})" style="flex: 1;">
                                <i class="fas fa-times"></i> Reprovar
                            </button>
                            <button class="btn btn-secondary" onclick="verDetalhesEntrada(${entrada.id})">
                                <i class="fas fa-eye"></i> Ver Placas
                            </button>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        async function aprovarEntrada(id) {
            if (!confirm('Deseja aprovar esta entrada? Todas as placas serão inseridas no banco de dados.')) return;
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/entradas/${id}/aprovar`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    alert('Entrada aprovada com sucesso!');
                    carregarEntradas();
                } else {
                    alert('Erro ao aprovar entrada');
                }
            } catch (error) {
                console.error('Erro:', error);
            }
        }

        async function reprovarEntrada(id) {
            const observacoes = prompt('Motivo da reprovação:');
            if (!observacoes) return;
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/entradas/${id}/reprovar`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ observacoes })
                });

                if (response.ok) {
                    alert('Entrada reprovada.');
                    carregarEntradas();
                } else {
                    alert('Erro ao reprovar entrada');
                }
            } catch (error) {
                console.error('Erro:', error);
            }
        }

        function verDetalhesEntrada(id) {
            const entrada = entradas.find(e => e.id === id);
            if (!entrada) return;
            
            let html = `<h3>Placas da Entrada #${id}</h3><div style="max-height: 60vh; overflow-y: auto;">`;
            entrada.placas.forEach(placa => {
                html += `
                    <div style="border: 1px solid #ddd; padding: 1rem; margin-bottom: 0.5rem; border-radius: 5px;">
                        <p><strong>Tag:</strong> ${placa.tag}</p>
                        <p><strong>Tipo:</strong> ${placa.tipo_placa}</p>
                        <p><strong>Peso:</strong> ${placa.peso_kg} kg</p>
                        <p><strong>Valor:</strong> R$ ${placa.valor.toFixed(2)}</p>
                    </div>
                `;
            });
            html += '</div>';
            
            const modal = document.createElement('div');
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;" onclick="this.remove()">
                    <div style="background: white; padding: 2rem; border-radius: 10px; max-width: 600px; width: 90%;" onclick="event.stopPropagation()">
                        ${html}
                        <button class="btn btn-secondary w-full" onclick="this.closest('[style*=fixed]').remove()">Fechar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function filtrarEntradas() {
            carregarEntradas();
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/';
        }

        carregarEntradas();
    </script>
</body>
</html>
